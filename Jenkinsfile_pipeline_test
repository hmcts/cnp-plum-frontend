#!groovy

// ______        _   _       _     _____
// |  _  \      | \ | |     | |   /  __ \
// | | | |___   |  \| | ___ | |_  | /  \/ ___  _ __  _   _
// | | | / _ \  | . ` |/ _ \| __| | |    / _ \| '_ \| | | |
// | |/ / (_) | | |\  | (_) | |_  | \__/\ (_) | |_) | |_| |
// |___/ \___/  \_| \_/\___/ \__|  \____/\___/| .__/ \__, |
//                                            | |     __/ |
//                                            |_|    |___/
//
// THIS PIPELINE IS FOR TESTING SHARED PIPELINE CODE ONLY

properties([
  parameters([
    string(name: 'LIB_VERSION', defaultValue: 'feature/DTSPO-28862-dual-acr-publish', description: 'Branch name of pipeline library to use')
  ])
])

library "Infrastructure@${params.LIB_VERSION}"

def type = "nodejs"

def product = "crumble"

def app = "frontend"


withPipeline(type, product, app) {
  // never skip stages when testing the pipeline
  env.NO_SKIP_IMG_BUILD = 'true'
  
  // Dual ACR publish configuration for testing DTSPO-28862
  // Primary ACR (from Key Vault) = hmctssandbox (sandbox primary)
  // Secondary ACR = hmctssbox (new ZA-enabled sandbox ACR)
  env.DUAL_ACR_PUBLISH = 'true'
  env.SECONDARY_REGISTRY_NAME = 'hmctssbox'
  env.SECONDARY_REGISTRY_RESOURCE_GROUP = 'cnp-acr-rg'
  env.SECONDARY_REGISTRY_SUBSCRIPTION = 'DCD-CFT-Sandbox'
  
  before('functionalTest:sandbox') {
    sh """
      yarn install
      yarn playwright install
    """
  }
  disableLegacyDeployment()
}
