version: 1.0-preview-1
steps:
  - id: pull-base-image-amd64
    cmd: docker pull --platform linux/amd64 hmctspublic.azurecr.io/base/node:16-alpine && docker tag hmctspublic.azurecr.io/base/node:16-alpine hmctspublic.azurecr.io/base/node/linux/amd64:16-alpine
    when: ["-"]
    keep: true

  - id: pull-base-amd64
    cmd: docker pull hmctspublic.azurecr.io/plum/frontend/base:amd64 || true
    when:
      - pull-base-image-amd64
    keep: true

  - id: base-amd64
    build: >
      -t hmctspublic.azurecr.io/plum/frontend/base:amd64
      --cache-from hmctspublic.azurecr.io/plum/frontend/base:amd64
      --build-arg REGISTRY_NAME=hmctspublic
      --build-arg PLATFORM=/linux/amd64
      --platform Linux/amd64
      --target base
      .
    when:
      - pull-base-amd64
    keep: true

  - id: runtime-amd64
    build: >
      -t hmctspublic.azurecr.io/plum/frontend:test-amd64
      --cache-from hmctspublic.azurecr.io/plum/frontend/base:amd64
      --build-arg REGISTRY_NAME=hmctspublic
      --build-arg PLATFORM=/linux/amd64
      --platform Linux/amd64
      --target runtime
      .
    when:
      - base-amd64
    keep: true

  - id: pull-base-image-arm64
    cmd: docker pull --platform linux/arm64 hmctspublic.azurecr.io/base/node:16-alpine && docker tag hmctspublic.azurecr.io/base/node:16-alpine hmctspublic.azurecr.io/base/node/linux/arm64:16-alpine
    when:
      - pull-base-image-amd64
    keep: true

  - id: pull-base-arm64
    cmd: docker pull hmctspublic.azurecr.io/plum/frontend/base-arm64:latest || true
    when:
      - pull-base-image-arm64
    keep: true

  - id: base-arm64
    build: >
      -t hmctspublic.azurecr.io/plum/frontend/base:arm64
      --cache-from hmctspublic.azurecr.io/plum/frontend/base:arm64
      --build-arg REGISTRY_NAME=hmctspublic
      --build-arg PLATFORM=/linux/arm64
      --platform Linux/arm64/v8
      --target base
      .
    when:
      - pull-base-arm64
    keep: true

  - id: runtime-arm64
    build: >
      -t hmctspublic.azurecr.io/plum/frontend:test-arm64
      --cache-from hmctspublic.azurecr.io/plum/frontend/base:arm64
      --build-arg REGISTRY_NAME=hmctspublic
      --build-arg PLATFORM=/linux/arm64
      --platform Linux/arm64/v8
      --target runtime
      .
    when:
      - base-arm64
    keep: true

  - id: push-images
    push:
      - "hmctspublic.azurecr.io/plum/frontend/base:amd64"
      - "hmctspublic.azurecr.io/plum/frontend:test-amd64"
      - "hmctspublic.azurecr.io/plum/frontend/base:arm64"
      - "hmctspublic.azurecr.io/plum/frontend:test-arm64"
    when:
      - runtime-amd64
      - runtime-arm64

  - id: manifest-create
    cmd: docker manifest create hmctspublic.azurecr.io/plum/frontend:test hmctspublic.azurecr.io/plum/frontend/base:amd64 hmctspublic.azurecr.io/plum/frontend:test-arm64
    when:
      - push-images
    keep: true

  - id: manifest-push
    cmd: docker manifest push --purge hmctspublic.azurecr.io/plum/frontend:test
    when:
      - manifest-create
    keep: true
