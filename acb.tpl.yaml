version: 1.0-preview-1
steps:
  - id: pull-base-base-amd64
    cmd: docker pull {{.Run.Registry}}/plum/frontend/base-amd64:latest || true
    when: ["-"]
    keep: true

  - id: base-amd64
    build: >
      -t {{.Run.Registry}}/plum/frontend/base-amd64
      --cache-from {{.Run.Registry}}/plum/frontend/base-amd64:latest
      --build-arg REGISTRY_NAME={{REGISTRY_NAME}} PLATFORM=linux/amd64
      --platform linux/amd64
      --target base
      .
    when:
      - pull-base-base-amd64
    keep: true

  - id: runtime-amd64
    build: >
      -t {{.Run.Registry}}/{{CI_IMAGE_TAG}}-amd64
      --cache-from {{.Run.Registry}}/plum/frontend/base-amd64:latest
      --build-arg REGISTRY_NAME={{REGISTRY_NAME}} PLATFORM=linux/amd64
      --platform linux/amd64
      --target runtime
      .
    when:
      - base-amd64
    keep: true

  - id: push-images-amd64
    push:
      - "{{.Run.Registry}}/plum/frontend/base-amd64:latest"
      - "{{.Run.Registry}}/{{CI_IMAGE_TAG}}-amd64"
    when:
      - runtime-amd64

  - id: pull-base-base-arm64
    cmd: docker pull {{.Run.Registry}}/plum/frontend/base-arm64:latest || true
    when: ["-"]
    keep: true

  - id: base-arm64
    build: >
      -t {{.Run.Registry}}/plum/frontend/base-arm64
      --cache-from {{.Run.Registry}}/plum/frontend/base-arm64:latest
      --build-arg REGISTRY_NAME={{REGISTRY_NAME}} PLATFORM=linux/arm64
      --platform linux/arm64
      --target base
      .
    when:
      - pull-base-base-arm64
    keep: true

  - id: runtime-arm64
    build: >
      -t {{.Run.Registry}}/{{CI_IMAGE_TAG}}-arm64
      --cache-from {{.Run.Registry}}/plum/frontend/base-arm64:latest
      --build-arg REGISTRY_NAME={{REGISTRY_NAME}} PLATFORM=linux/arm64
      --platform linux/arm64
      --target runtime
      .
    when:
      - base-arm64
    keep: true

  - id: push-images-arm64
    push:
      - "{{.Run.Registry}}/plum/frontend/base-arm64:latest"
      - "{{.Run.Registry}}/{{CI_IMAGE_TAG}}-arm64"
    when:
      - runtime-arm64

  - id: manifest-create
    cmd: docker manifest create {{.Run.Registry}}/{{CI_IMAGE_TAG}} {{.Run.Registry}}/{{CI_IMAGE_TAG}}-amd64 {{.Run.Registry}}/{{CI_IMAGE_TAG}}-arm64
    when:
      - push-images-amd64
      - push-images-arm64
    keep: true

  - id: manifest-push
    cmd: docker manifest push {{.Run.Registry}}/{{CI_IMAGE_TAG}}
    when:
      - manifest-create
    keep: true
