version: 1.0-preview-1
steps:
  - id: setup-qemu
    cmd: docker run --rm --privileged tonistiigi/binfmt --uninstall qemu-* ; docker run --rm --privileged tonistiigi/binfmt --install arm64
    retries: 3
    retryDelay: 5
    when: ['-']

  - id: pull-base-image-amd64
    cmd: docker pull --platform linux/amd64 {{REGISTRY_NAME}}.azurecr.io/base/node:20-alpine && docker tag {{REGISTRY_NAME}}.azurecr.io/base/node:20-alpine base-node-amd64:local
    retries: 10
    retryDelay: 5
    when: ['setup-qemu']

  - id: pull-base-amd64
    cmd: docker pull {{.Run.Registry}}/plum/frontend/base:amd64 || true
    retries: 10
    retryDelay: 5
    when:
      - pull-base-image-amd64

  - id: base-amd64
    build: >
      -t {{.Run.Registry}}/plum/frontend/base:amd64
      --cache-from {{.Run.Registry}}/plum/frontend/base:amd64
      --build-arg BASE_IMAGE=base-node-amd64:local
      --platform linux/amd64
      --target base
      .
    retries: 10
    retryDelay: 5
    when:
      - pull-base-amd64

  - id: runtime-amd64
    build: >
      -t {{.Run.Registry}}/{{CI_IMAGE_TAG}}-amd64
      --cache-from {{.Run.Registry}}/plum/frontend/base:amd64
      --build-arg BASE_IMAGE=base-node-amd64:local
      --platform linux/amd64
      --target runtime
      .
    retries: 10
    retryDelay: 5
    when:
      - base-amd64

  - id: pull-base-image-arm64
    cmd: docker pull --platform linux/arm64 {{REGISTRY_NAME}}.azurecr.io/base/node:20-alpine && docker tag {{REGISTRY_NAME}}.azurecr.io/base/node:20-alpine base-node-arm64:local
    retries: 10
    retryDelay: 5
    when:
      - setup-qemu

  - id: pull-base-arm64
    cmd: docker pull {{.Run.Registry}}/plum/frontend/base-arm64:latest || true
    retries: 10
    retryDelay: 5
    when:
      - pull-base-image-arm64

  - id: base-arm64
    build: >
      -t {{.Run.Registry}}/plum/frontend/base:arm64
      --cache-from {{.Run.Registry}}/plum/frontend/base:arm64
      --build-arg BASE_IMAGE=base-node-arm64:local
      --platform linux/arm64
      --target base
      .
    retries: 10
    retryDelay: 5
    when:
      - pull-base-arm64

  - id: runtime-arm64
    build: >
      -t {{.Run.Registry}}/{{CI_IMAGE_TAG}}-arm64
      --cache-from {{.Run.Registry}}/plum/frontend/base:arm64
      --build-arg BASE_IMAGE=base-node-arm64:local
      --platform linux/arm64
      --target runtime
      .
    retries: 10
    retryDelay: 5
    when:
      - base-arm64

  - id: push-images
    push:
      - '{{.Run.Registry}}/plum/frontend/base:amd64'
      - '{{.Run.Registry}}/{{CI_IMAGE_TAG}}-amd64'
      - '{{.Run.Registry}}/plum/frontend/base:arm64'
      - '{{.Run.Registry}}/{{CI_IMAGE_TAG}}-arm64'
    retries: 10
    retryDelay: 5
    when:
      - runtime-amd64
      - runtime-arm64

  - id: manifest-create
    cmd: docker manifest create --amend {{.Run.Registry}}/{{CI_IMAGE_TAG}} {{.Run.Registry}}/{{CI_IMAGE_TAG}}-amd64 {{.Run.Registry}}/{{CI_IMAGE_TAG}}-arm64
    retries: 10
    retryDelay: 5
    when:
      - push-images

  - id: manifest-push
    cmd: docker manifest push --purge {{.Run.Registry}}/{{CI_IMAGE_TAG}}
    retries: 10
    retryDelay: 5
    when:
      - manifest-create
